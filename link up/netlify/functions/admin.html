<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>Admin Dashboard</title>
<style>
  body{font-family:Inter,system-ui,Arial,sans-serif;background:#f4f6fb;margin:0;padding:20px}
  .wrap{max-width:1100px;margin:20px auto}
  h1{margin:0 0 12px 0}
  .cols{display:grid;grid-template-columns:1fr 1fr;gap:16px}
  .panel{background:white;padding:14px;border-radius:12px;box-shadow:0 6px 20px rgba(16,24,40,0.06)}
  .item{display:flex;gap:12px;align-items:flex-start;padding:10px;border-radius:10px;border:1px solid #eef2ff;margin-bottom:10px}
  .item img{width:72px;height:72px;border-radius:10px;object-fit:cover}
  .btn{padding:8px 12px;border-radius:8px;border:none;cursor:pointer;font-weight:700}
  .approve{background:#2f9e44;color:white}
  .dismiss{background:#94a3b8;color:white}
  .delete{background:#e03131;color:white}
</style>
</head>
<body>
<div class="wrap">
  <h1>Admin — Payments & Reports</h1>
  <div class="cols">
    <div class="panel" id="paymentsPanel">
      <h3>Pending Payments</h3>
      <div id="paymentsList"></div>
    </div>

    <div class="panel" id="reportsPanel">
      <h3>Reports</h3>
      <div id="reportsList"></div>
    </div>
  </div>

  <div style="margin-top:18px" class="panel">
    <h3>Approved Paid Users (will appear on signup gating)</h3>
    <div id="approvedPaid"></div>
  </div>
</div>

<script>
const API_BASE = window.location.hostname === 'localhost' 
  ? 'http://localhost:8888/.netlify/functions' 
  : '/.netlify/functions';

let pending = [];
let paid = [];
let reports = [];

/* API helper */
async function apiCall(endpoint, options = {}) {
  try {
    const response = await fetch(`${API_BASE}/${endpoint}`, {
      headers: {
        'Content-Type': 'application/json',
        ...options.headers
      },
      ...options
    });
    
    if (!response.ok) {
      throw new Error(`API error: ${response.status}`);
    }
    
    return await response.json();
  } catch (error) {
    console.error('API call failed:', error);
    // Fallback to localStorage
    return fallbackData(endpoint);
  }
}

function fallbackData(endpoint) {
  const lsData = {
    'payments': {
      pending: JSON.parse(localStorage.getItem("pendingPayments")) || [],
      paid: JSON.parse(localStorage.getItem("paidUsers")) || []
    },
    'reports': JSON.parse(localStorage.getItem("reports")) || []
  };
  
  return lsData[endpoint] || {};
}

/* Load all data */
async function loadData() {
  try {
    const [paymentsResponse, reportsResponse] = await Promise.all([
      apiCall('payments'),
      apiCall('reports')
    ]);
    
    pending = paymentsResponse.pending || [];
    paid = paymentsResponse.paid || [];
    reports = reportsResponse || [];
    
    renderPending();
    renderReports();
    renderApprovedPaid();
  } catch (error) {
    console.error('Failed to load data:', error);
  }
}

/* render pending payments */
function renderPending(){
  const el = document.getElementById("paymentsList");
  el.innerHTML = "";
  if(pending.length === 0){ el.innerHTML = "<p>No pending payments.</p>"; return; }
  pending.forEach((p, i)=>{
    const div = document.createElement("div");
    div.className = "item";
    div.innerHTML = `
      <img src="${p.photo||'https://via.placeholder.com/72'}">
      <div style="flex:1">
        <div style="font-weight:800">${p.name}</div>
        <div style="font-size:13px;color:#475569">${p.url}</div>
        <div style="margin-top:8px"><img src="${p.proof}" style="max-width:240px;border-radius:8px;border:1px solid #e6eef8"></div>
      </div>
      <div style="display:flex;flex-direction:column;gap:8px">
        <button class="btn approve" onclick="approvePayment('${p.id}')">Approve</button>
        <button class="btn delete" onclick="rejectPayment('${p.id}')">Reject</button>
      </div>
    `;
    el.appendChild(div);
  });
}

/* render reports */
function renderReports(){
  const el = document.getElementById("reportsList");
  el.innerHTML = "";
  if(reports.length === 0){ el.innerHTML = "<p>No reports.</p>"; return; }
  reports.forEach((r, i)=>{
    const div = document.createElement("div");
    div.className = "item";
    div.innerHTML = `
      <div style="flex:1">
        <div><b>Reported:</b> ${r.reported}</div>
        <div><b>Reporter:</b> ${r.reporter}</div>
        <div style="margin-top:6px">${r.reason}</div>
        <div style="font-size:12px;color:#94a3b8;margin-top:6px">${r.when||''}</div>
      </div>
      <div style="display:flex;flex-direction:column;gap:8px">
        <button class="btn delete" onclick="deleteUser('${r.reported}', '${r.id}')">Delete User</button>
        <button class="btn dismiss" onclick="dismissReport('${r.id}')">Dismiss</button>
      </div>
    `;
    el.appendChild(div);
  });
}

/* render approved paid users */
function renderApprovedPaid(){
  const el = document.getElementById("approvedPaid");
  el.innerHTML = "";
  if(paid.length === 0){ el.innerHTML = "<p>No approved paid users.</p>"; return; }
  paid.forEach((p,i)=>{
    const div = document.createElement("div");
    div.className = "item";
    div.innerHTML = `
      <img src="${p.photo||'https://via.placeholder.com/72'}">
      <div style="flex:1">
        <div style="font-weight:800">${p.name}</div>
        <div style="color:#475569">${p.url}</div>
      </div>
      <div>
        <button class="btn delete" onclick="removePaid('${p.id}')">Remove</button>
      </div>
    `;
    el.appendChild(div);
  });
}

/* actions */
async function approvePayment(paymentId){
  try {
    const result = await apiCall(`payments/approve/${paymentId}`, {
      method: 'POST'
    });
    
    if (result.success) {
      alert("Payment approved — user added to paid users list.");
      await loadData();
    } else {
      throw new Error('API failed');
    }
  } catch (error) {
    console.error('API failed, using localStorage:', error);
    // Fallback to localStorage
    const pendingPayments = JSON.parse(localStorage.getItem("pendingPayments")) || [];
    const paidUsers = JSON.parse(localStorage.getItem("paidUsers")) || [];
    
    const paymentIndex = pendingPayments.findIndex(p => p.id === paymentId);
    if (paymentIndex >= 0) {
      const approvedPayment = pendingPayments[paymentIndex];
      paidUsers.push({
        ...approvedPayment,
        approvedAt: new Date().toISOString()
      });
      pendingPayments.splice(paymentIndex, 1);
      
      localStorage.setItem("pendingPayments", JSON.stringify(pendingPayments));
      localStorage.setItem("paidUsers", JSON.stringify(paidUsers));
      
      alert("Payment approved — user added to paid users list.");
      loadData();
    }
  }
}

async function rejectPayment(paymentId){
  if(!confirm("Reject this payment?")) return;
  
  try {
    const result = await apiCall(`payments/reject/${paymentId}`, {
      method: 'POST'
    });
    
    if (result.success) {
      await loadData();
    } else {
      throw new Error('API failed');
    }
  } catch (error) {
    console.error('API failed, using localStorage:', error);
    // Fallback to localStorage
    const pendingPayments = JSON.parse(localStorage.getItem("pendingPayments")) || [];
    const paymentIndex = pendingPayments.findIndex(p => p.id === paymentId);
    
    if (paymentIndex >= 0) {
      pendingPayments.splice(paymentIndex, 1);
      localStorage.setItem("pendingPayments", JSON.stringify(pendingPayments));
      loadData();
    }
  }
}

async function deleteUser(userName, reportId){
  if(!confirm(`Delete user ${userName}? This will remove them from the system.`)) return;
  
  try {
    // Remove from users (localStorage only for now)
    const users = JSON.parse(localStorage.getItem("users")) || [];
    const updatedUsers = users.filter(u => u.name !== userName);
    localStorage.setItem("users", JSON.stringify(updatedUsers));
    
    // Remove XP data
    const xpData = JSON.parse(localStorage.getItem("xpData")) || {};
    delete xpData[userName];
    localStorage.setItem("xpData", JSON.stringify(xpData));
    
    // Remove clicked data
    const clickedData = JSON.parse(localStorage.getItem("clickedData")) || {};
    delete clickedData[userName];
    // Also remove from other users' clicked lists
    Object.keys(clickedData).forEach(user => {
      if (clickedData[user]) {
        clickedData[user] = clickedData[user].filter(target => target !== userName);
      }
    });
    localStorage.setItem("clickedData", JSON.stringify(clickedData));
    
    // Remove report
    await dismissReport(reportId);
    
    alert("User deleted.");
  } catch (error) {
    console.error('Error deleting user:', error);
  }
}

async function dismissReport(reportId){
  try {
    const result = await apiCall(`reports/${reportId}`, {
      method: 'DELETE'
    });
    
    if (result.success) {
      await loadData();
    } else {
      throw new Error('API failed');
    }
  } catch (error) {
    console.error('API failed, using localStorage:', error);
    // Fallback to localStorage
    const reports = JSON.parse(localStorage.getItem("reports")) || [];
    const reportIndex = reports.findIndex(r => r.id === reportId);
    
    if (reportIndex >= 0) {
      reports.splice(reportIndex, 1);
      localStorage.setItem("reports", JSON.stringify(reports));
      loadData();
    }
  }
}

async function removePaid(paidId){
  if(!confirm("Remove this user from paid users?")) return;
  
  try {
    const result = await apiCall(`payments/paid/${paidId}`, {
      method: 'DELETE'
    });
    
    if (result.success) {
      await loadData();
    } else {
      throw new Error('API failed');
    }
  } catch (error) {
    console.error('API failed, using localStorage:', error);
    // Fallback to localStorage
    const paidUsers = JSON.parse(localStorage.getItem("paidUsers")) || [];
    const paidIndex = paidUsers.findIndex(p => p.id === paidId);
    
    if (paidIndex >= 0) {
      paidUsers.splice(paidIndex, 1);
      localStorage.setItem("paidUsers", JSON.stringify(paidUsers));
      loadData();
    }
  }
}

/* initial render */
loadData();
</script>
</body>
</html>
