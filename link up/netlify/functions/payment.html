<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>Payment — Upload Proof</title>
<style>
  body{font-family:Inter,system-ui,Arial,sans-serif;background:#f3f6fb;margin:0;padding:20px}
  .card{max-width:640px;margin:36px auto;background:white;padding:20px;border-radius:12px;box-shadow:0 6px 20px rgba(16,24,40,0.06)}
  .profile{display:flex;gap:12px;align-items:center;margin-bottom:14px}
  img{width:72px;height:72px;border-radius:10px;object-fit:cover}
  .bank{background:#eef2ff;padding:12px;border-radius:10px;margin-bottom:14px}
  input[type=file]{margin-top:8px}
  button{background:#1976d2;color:white;border:none;padding:10px 14px;border-radius:10px;cursor:pointer}
</style>
</head>
<body>
<div class="card">
  <h2>Payment — Upload Proof</h2>
  <div id="userArea"></div>

  <div class="bank">
    <strong>Send $5</strong><br>
    UBA — 1234567890 — Waps<br>
    Ecobank — 9876543210 — Waps
  </div>

  <form id="paymentForm">
    <label>Upload proof (screenshot of transfer):</label><br>
    <input type="file" id="proofFile" accept="image/*" required><br>
    <button type="submit">Submit Proof</button>
  </form>
</div>

<script>
const API_BASE = window.location.hostname === 'localhost' 
  ? 'http://localhost:8888/.netlify/functions' 
  : '/.netlify/functions';

const pendingUser = JSON.parse(localStorage.getItem("pendingPaymentUser"));
if(!pendingUser){
  alert("No user ready for payment. Please click Pay on your dashboard.");
  window.location.href = "index.html";
}

document.getElementById('userArea').innerHTML = `
  <div class="profile">
    <img src="${pendingUser.photo||'https://via.placeholder.com/72'}" alt="">
    <div>
      <div style="font-weight:800">${pendingUser.name}</div>
      <div style="color:#334155">${pendingUser.url}</div>
    </div>
  </div>
`;

/* API helper */
async function apiCall(endpoint, options = {}) {
  try {
    const response = await fetch(`${API_BASE}/${endpoint}`, {
      headers: {
        'Content-Type': 'application/json',
        ...options.headers
      },
      ...options
    });
    
    if (!response.ok) {
      throw new Error(`API error: ${response.status}`);
    }
    
    return await response.json();
  } catch (error) {
    console.error('API call failed:', error);
    return { success: false };
  }
}

document.getElementById("paymentForm").addEventListener("submit", async function(e){
  e.preventDefault();
  const f = document.getElementById("proofFile").files[0];
  if(!f){ alert("Upload proof"); return; }
  const r = new FileReader();
  r.onload = async function(ev){
    const proofData = ev.target.result;
    
    try {
      // Save payment via API
      const result = await apiCall('payments/pending', {
        method: 'POST',
        body: JSON.stringify({
          name: pendingUser.name,
          url: pendingUser.url,
          photo: pendingUser.photo,
          proof: proofData
        })
      });
      
      if (result.success) {
        alert("Payment proof submitted. Admin will review and approve.");
        // clear pendingPaymentUser
        localStorage.removeItem("pendingPaymentUser");
        window.location.href = "index.html";
      } else {
        throw new Error('API failed');
      }
    } catch (error) {
      console.error('API submission failed, using localStorage:', error);
      // Fallback to localStorage
      const pendingPayments = JSON.parse(localStorage.getItem("pendingPayments")) || [];
      pendingPayments.push({
        name: pendingUser.name,
        url: pendingUser.url,
        photo: pendingUser.photo,
        proof: proofData,
        when: new Date().toISOString()
      });
      localStorage.setItem("pendingPayments", JSON.stringify(pendingPayments));
      alert("Payment proof submitted. Admin will review and approve.");
      localStorage.removeItem("pendingPaymentUser");
      window.location.href = "index.html";
    }
  };
  r.readAsDataURL(f);
});
</script>
</body>
</html>
